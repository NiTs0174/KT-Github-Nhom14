--2180601448
--Nguyễn Minh Thắng
----------------------TAO CSDL------------------------------------------------------------------------
CREATE DATABASE QLSP
GO
USE QLSP
GO
-----------------------TAO BANG-----------------------------------------------------------------------
SET DATEFORMAT DMY

CREATE TABLE LOAISP(
	MALOAI VARCHAR(5) NOT NULL PRIMARY KEY (MALOAI),
	TENLOAI NVARCHAR(30) NOT NULL,
);

CREATE TABLE SANPHAM(
	MASP VARCHAR(5) NOT NULL PRIMARY KEY(MASP),
	TENSP NVARCHAR(30) NOT NULL,
	MOTA NVARCHAR(50),
	GIA FLOAT,
	MALOAI VARCHAR(5) FOREIGN KEY REFERENCES LOAISP(MALOAI),
);	

CREATE TABLE KHACHHANG(
	MAKH VARCHAR(5) NOT NULL PRIMARY KEY (MAKH),
	TENKH NVARCHAR(30) NOT NULL,
	DC NVARCHAR(50),
	DT VARCHAR(11),
);

CREATE TABLE DONDH(
	SODDH VARCHAR(5) NOT NULL PRIMARY KEY(SODDH),
	NGAYDAT DATE,
	MAKH VARCHAR(5) FOREIGN KEY REFERENCES KHACHHANG(MAKH),
);

CREATE TABLE CTDDH(
	SODDH VARCHAR(5) NOT NULL FOREIGN KEY REFERENCES DONDH(SODDH),
	MASP VARCHAR(5) NOT NULL FOREIGN KEY REFERENCES SANPHAM(MASP),
	SOLUONG FLOAT CHECK (SOLUONG>0),
	CONSTRAINT PK_CTDDH PRIMARY KEY(SODDH,MASP),
);

CREATE TABLE NGUYENLIEU(
	MANL VARCHAR(5) NOT NULL PRIMARY KEY(MANL),
	TENNL NVARCHAR(20) NOT NULL,
	DVT VARCHAR(5),
	GIA FLOAT,
);

CREATE TABLE LAM(
	MANL VARCHAR(5) NOT NULL FOREIGN KEY REFERENCES NGUYENLIEU(MANL),
	MASP VARCHAR(5) NOT NULL FOREIGN KEY REFERENCES SANPHAM(MASP),
	SOLUONG FLOAT CHECK (SOLUONG>0),
	PRIMARY KEY(MANL,MASP),
);
--------------------------------------------------------------------------------------------
--NHAP LIEU
INSERT INTO LOAISP VALUES('L01',N'Tủ')
INSERT INTO LOAISP VALUES('L02',N'Bàn')
INSERT INTO LOAISP VALUES('L03',N'Giường')
SELECT * FROM LOAISP;

INSERT INTO SANPHAM VALUES('SP01',N'Tủ trang điểm',N'Cao 1.4m, rộng 2.2m',1000000,'L01')
INSERT INTO SANPHAM VALUES('SP02',N'Giường đơn Cali',N'rộng 1.4m',1500000,'L03')
INSERT INTO SANPHAM VALUES('SP03',N'Tủ DDA',N'Cao 1.6m, rộng 2.0m, cửa kiếng',800000,'L01')
INSERT INTO SANPHAM VALUES('SP04',N'Bàn ăn',N'1m x 1.5m',650000,'L02')
INSERT INTO SANPHAM VALUES('SP05',N'Bàn uống trà',N'Tròn 1.8m',1100000,'L02')
SELECT * FROM SANPHAM;

INSERT INTO KHACHHANG VALUES('KH001',N'Trần Hải Cường',N'731 Trần Hưng Đạo, Q.1, TP.HCM','08-9776655')
INSERT INTO KHACHHANG VALUES('KH002',N'Nguyễn Thi Bé',N'638 Nguyễn Văn Cừ, Q.5, TP.HCM','0913-666123')
INSERT INTO KHACHHANG VALUES('KH003',N'Trần Thị Minh Hòa',N'543 Mai Thị Lựu, Ba Đình, Hà Nội','04-9238777')
INSERT INTO KHACHHANG VALUES('KH004',N'Phạm Đình Tuân',N'975 Lê Lai, P.3, TP. Vũng Tàu ','064-543678')
INSERT INTO KHACHHANG VALUES('KH005',N'Lê Xuân Nguyện',N'450 Trưng Vương, TP. Mỹ Tho, Tiền Giang','073-987123')
INSERT INTO KHACHHANG VALUES('KH006',N'Văn Hùng Dũng',N'291 Hồ Văn Huê, Q. PN, TP.HCM','08-8222111')
INSERT INTO KHACHHANG VALUES('KH012',N'Lê Thị Hương Hoa',N'980 Lê Hồng Phong, TP. Vũng Tàu','064-452100')
INSERT INTO KHACHHANG VALUES('KH016',N'Hà Minh Trí',N'332 Nguyễn Thái Học, TP. Quy Nhơn','056-565656')
SELECT * FROM KHACHHANG;

INSERT INTO DONDH VALUES('DH001','15/3/2010','KH001')
INSERT INTO DONDH VALUES('DH002','15/3/2010','KH016')
INSERT INTO DONDH VALUES('DH003','16/3/2010','KH003')
INSERT INTO DONDH VALUES('DH004','15/3/2010','KH012')
INSERT INTO DONDH VALUES('DH005','17/3/2010','KH001')
INSERT INTO DONDH VALUES('DH006','01/04/2010','KH002')
SELECT * FROM DONDH;

INSERT INTO CTDDH VALUES('DH001','SP01',5)
INSERT INTO CTDDH VALUES('DH001','SP03',1)
INSERT INTO CTDDH VALUES('DH002','SP02',2)
INSERT INTO CTDDH VALUES('DH003','SP01',2)
INSERT INTO CTDDH VALUES('DH003','SP04',10)
INSERT INTO CTDDH VALUES('DH003','SP05',5)
INSERT INTO CTDDH VALUES('DH004','SP02',2)
INSERT INTO CTDDH VALUES('DH004','SP05',2)
INSERT INTO CTDDH VALUES('DH005','SP03',3)
INSERT INTO CTDDH VALUES('DH006','SP02',4)
INSERT INTO CTDDH VALUES('DH006','SP04',3)
INSERT INTO CTDDH VALUES('DH006','SP05',6)
SELECT * FROM CTDDH;

INSERT INTO NGUYENLIEU VALUES('NL01',N'Gỗ Lim XP','m3',1200000)
INSERT INTO NGUYENLIEU VALUES('NL02',N'Gỗ Sao NT','m3',1000000)
INSERT INTO NGUYENLIEU VALUES('NL03',N'Gỗ tạp nham','m3',500000)
INSERT INTO NGUYENLIEU VALUES('NL04',N'Đinh lớn','kg',40000)
INSERT INTO NGUYENLIEU VALUES('NL05',N'Đinh nhỏ','kg',30000)
INSERT INTO NGUYENLIEU VALUES('NL06',N'Kiếng','m2',350000)
SELECT * FROM NGUYENLIEU;

INSERT INTO LAM VALUES('NL01','SP01',1.2)
INSERT INTO LAM VALUES('NL03','SP01',0.3)
INSERT INTO LAM VALUES('NL06','SP01',2.5)
INSERT INTO LAM VALUES('NL02','SP02',1.1)
INSERT INTO LAM VALUES('NL04','SP02',2.2)
INSERT INTO LAM VALUES('NL02','SP03',0.9)
INSERT INTO LAM VALUES('NL05','SP03',2.1)
INSERT INTO LAM VALUES('NL02','SP04',1.3)
INSERT INTO LAM VALUES('NL04','SP04',1.7)
INSERT INTO LAM VALUES('NL03','SP05',0.8)
INSERT INTO LAM VALUES('NL05','SP05',0.5)
INSERT INTO LAM VALUES('NL06','SP05',2.4)
SELECT * FROM LAM;
--------------------VIEW--------------------------------------------------------
--1.Danh sách các loại sản phẩm có nhiều sản phẩm nhất (Tên loại SP, số sản phẩm).
CREATE VIEW V1 
AS
	SELECT TOP 1 WITH TIES S.MASP,TENLOAI,SOLUONG
	FROM LOAISP L JOIN SANPHAM S ON L.MALOAI=S.MALOAI
					JOIN CTDDH C ON C.MASP=S.MASP
	ORDER BY SOLUONG DESC
GO
SELECT * FROM V1 

--2.Danh sách khách hàng không đặt hàng trong tháng 3/2010 (Tên KH, địa chỉ).
CREATE VIEW V2
AS
	SELECT TENKH,DC
	FROM KHACHHANG
	WHERE MAKH NOT IN(SELECT D.MAKH FROM CTDDH C JOIN DONDH D ON C.SODDH=D.SODDH
						WHERE YEAR(NGAYDAT)=2010 AND MONTH(NGAYDAT)=3)
GO
SELECT * FROM V2

--3.DS khách hàng đặt nhiều đơn đặt hàng nhất trong tháng 3/2010 (Tên KH, địa chỉ).
CREATE VIEW V3
AS
	SELECT TOP 1 WITH TIES TENKH,DC,COUNT(C.SODDH)AS [SLDH]
	FROM KHACHHANG K JOIN DONDH D ON K.MAKH=D.MAKH
					JOIN CTDDH C ON C.SODDH=D.SODDH
	WHERE YEAR(NGAYDAT)=2010 AND MONTH(NGAYDAT)=3
	GROUP BY TENKH,DC
	ORDER BY COUNT(C.SODDH) DESC
GO
SELECT * FROM V3

--4.Danh sách các sản phẩm không được đặt trong tháng 3/2010 (Tên SP, mô tả).
CREATE VIEW V4
AS
	SELECT TENSP,MOTA
	FROM SANPHAM
	WHERE MASP NOT IN(SELECT C.MASP FROM CTDDH C JOIN DONDH D ON C.SODDH=D.SODDH
						WHERE YEAR(NGAYDAT)=2010 AND MONTH(NGAYDAT)=3)
GO
SELECT * FROM V4

--5.Danh sách khách hàng có đặt trên 10 cái tủ DDA (Tên KH, địa chỉ, tổng số lượng).
CREATE VIEW V5
AS
	SELECT TENKH,DC,SUM(C.SOLUONG)AS [TONGSL]
	FROM KHACHHANG K JOIN DONDH D ON K.MAKH=D.MAKH
					JOIN CTDDH C ON C.SODDH=D.SODDH
					JOIN SANPHAM S ON S.MASP=C.MASP
	WHERE TENSP=N'Tủ DDA'
	GROUP BY TENKH,DC
	HAVING SUM(C.SOLUONG)>10
GO
SELECT * FROM V5

--6.DS các sản phẩm được làm từ nhiều loại nguyên liệu nhất (Tên SP, Giá, Số loại).
CREATE VIEW V6
AS
	SELECT TOP 1 WITH TIES S.TENSP,GIA,COUNT(L.MANL) AS [SLNL]
	FROM SANPHAM S JOIN LAM L ON S.MASP=L.MASP
	GROUP BY TENSP,S.GIA
	ORDER BY COUNT(L.MANL) DESC
GO
SELECT * FROM V6

--7.Danh sách các sản phẩm có giá thành SX hơn 1 triệu (Tên SP, Giá thành SX).
CREATE VIEW V7
AS
	SELECT S.TENSP,[GIA THANH SX]=(N.GIA*SOLUONG)
	FROM SANPHAM S JOIN LAM L ON S.MASP=L.MASP
					JOIN NGUYENLIEU N ON N.MANL=L.MANL
	WHERE (N.GIA*SOLUONG)>1000000
GO
SELECT * FROM V7

--8.DS các sản phẩm có lãi trên 20% (Tên SP, Giá thành SX, Giá bán, phần trăm lãi).
CREATE VIEW V8
AS
	SELECT TENSP,S.GIA,GIATHANHSX=(N.GIA*SOLUONG),[LAI]=(S.GIA/(N.GIA*SOLUONG))*0.1
	FROM SANPHAM S JOIN LAM L ON S.MASP=L.MASP
					JOIN NGUYENLIEU N ON N.MANL=L.MANL
	WHERE (S.GIA/(N.GIA*SOLUONG))*0.1 > 2
GO
SELECT * FROM V8

--9.Danh sách đơn đặt hàng có tổng số tiền lớn hơn 100 triệu (Số DDH, Ngày đặt, Tổng tiền).
CREATE VIEW V9
AS
	SELECT D.SODDH,NGAYDAT,[TONGTIEN]=SUM(GIA*SOLUONG)
	FROM DONDH D JOIN CTDDH C ON C.SODDH=D.SODDH
				JOIN SANPHAM S ON S.MASP=C.MASP
	GROUP BY D.SODDH,NGAYDAT
	HAVING SUM(GIA*SOLUONG)>100000000
GO
SELECT * FROM V9

--10.Danh sách các loại nguyên liệu dùng để làm tất cả các sản phẩm (TênNL, Giá).
CREATE VIEW V10
AS
	SELECT TENNL,GIA
	FROM NGUYENLIEU N JOIN LAM L ON L.MANL=N.MANL
	GROUP BY TENNL,GIA
	HAVING COUNT(MASP) = (SELECT COUNT(MASP) FROM SANPHAM)
GO
SELECT * FROM V10

--11.Danh sách khách hàng có đặt tất cả các sản phẩm (Tên KH, DC).


--12.Danh sách các sản phẩm tất cả các khách hàng đều đặt (Tên SP, Mô tả).


--13.Danh sách khách hàng lâu nhất chưa đặt hàng (Tên KH, địa chỉ).


--------------------PROCEDURE--------------------------------------------------------
--1.Liệt kê DS khách hàng (TênKH, DC) có đặt hàng vào Ngày tháng năm X.
CREATE PROC P1 
@NGAYDAT DATE
AS
	BEGIN
		SELECT TENKH,DC
		FROM KHACHHANG K JOIN DONDH D ON D.MAKH=K.MAKH
		WHERE NGAYDAT=@NGAYDAT
	END 
GO
EXEC P1 '15/03/2010'

--2.Liệt kê DS khách hàng (TênKH, DC) có đặt hàng sản phẩm có mã số X.
CREATE PROC P2
@MASP VARCHAR(5)
AS
	BEGIN
		SELECT TENKH,DC
		FROM KHACHHANG K JOIN DONDH D ON D.MAKH=K.MAKH
						JOIN CTDDH C ON C.SODDH=D.SODDH
						JOIN SANPHAM S ON S.MASP=C.MASP
		WHERE S.MASP=@MASP
	END 
GO
EXEC P2 'SP01'

--3.Liệt kê DS khách hàng (TênKH, DC) có đặt hàng với tổng số tiền trên X (1 đơn).
CREATE PROC P3
@TONGTIEN INT
AS
	BEGIN
		SELECT TENKH,DC,SUM(GIA*SOLUONG) AS [TONG TIEN]
		FROM KHACHHANG K JOIN DONDH D ON D.MAKH=K.MAKH
						JOIN CTDDH C ON C.SODDH=D.SODDH
						JOIN SANPHAM S ON S.MASP=C.MASP
		GROUP BY TENKH,DC
		HAVING SUM(GIA*SOLUONG) > @TONGTIEN
	END 
GO
EXEC P3 '999999'

--4.Liệt kê DS khách hàng (TênKH, DC) có đặt hàng với tổng số tiền trên X (tất cả).
CREATE PROC P4
@TONGTIEN INT
AS
	BEGIN
		SELECT TENKH,DC,SUM(GIA*SOLUONG) AS [TONG TIEN]
		FROM KHACHHANG K JOIN DONDH D ON D.MAKH=K.MAKH
						JOIN CTDDH C ON C.SODDH=D.SODDH
						JOIN SANPHAM S ON S.MASP=C.MASP
		GROUP BY TENKH,DC
		HAVING SUM(GIA*SOLUONG) > @TONGTIEN
	END 
GO
EXEC P4 '999999'

--5.Liệt kê DS sản phẩm (TênSP, Giá thành SX, Giá) bán lãi trên X.
CREATE PROC P5
@LAI SMALLINT
AS
	BEGIN
		SELECT TENSP,S.GIA,[GIA THANH SX]=(N.GIA*SOLUONG),[LAI]=(S.GIA/(N.GIA*SOLUONG))*0.1
		FROM SANPHAM S JOIN LAM L ON L.MASP=S.MASP
						JOIN NGUYENLIEU N ON N.MANL=L.MANL
		WHERE (S.GIA/(N.GIA*SOLUONG))*0.1 > @LAI
	END 
GO
EXEC P5 2

--6.Liệt kê DS khách hàng (TênKH, DC) đã trên X ngày rồi chưa đặt hàng.


--7.Liệt kê DS sản phẩm (TênSP, Số đơn) có tổng số đơn đặt hàng trên X.
CREATE PROC P7
@TONGDH SMALLINT
AS
	BEGIN
		SELECT TENSP,SODDH,COUNT(SODDH)AS [TONGDH]
		FROM SANPHAM S JOIN CTDDH C ON C.MASP=S.MASP
		GROUP BY TENSP,SODDH
		HAVING COUNT(SODDH) > @TONGDH
	END 
GO
EXEC P7 0

--8.Liệt kê DS sản phẩm (TênSP, Tổng SL) có tổng số lượng đặt hàng trên X.
CREATE PROC P8
@TONGSL SMALLINT
AS
	BEGIN
		SELECT TENSP,SUM(SOLUONG)AS [TONGSL]
		FROM SANPHAM S JOIN CTDDH C ON C.MASP=S.MASP
		GROUP BY TENSP
		HAVING SUM(SOLUONG) > @TONGSL
	END 
GO
EXEC P8 5

--9.Liệt kê DS sản phẩm (TênSP, Tổng số tiền) có tổng số tiền đặt hàng trên X.
CREATE PROC P9
@TONGGIATIEN INT
AS
	BEGIN
		SELECT TENSP,SUM(GIA*SOLUONG)AS [TONGGIATIEN]
		FROM SANPHAM S JOIN CTDDH C ON C.MASP=S.MASP
		GROUP BY TENSP
		HAVING SUM(GIA*SOLUONG) > @TONGGIATIEN
	END 
GO
EXEC P9 8000000

-----------------------TRIGGER-----------------------------------------------------
--1.Mỗi ngày mỗi khách hàng chỉ đặt tối đa 2 đơn hàng.
CREATE TRIGGER T1 ON CTDDH
FOR INSERT
AS
	DECLARE @SODDH VARCHAR(5)
	SELECT @SODDH=SODDH FROM INSERTED
	IF(SELECT COUNT(*) FROM CTDDH C JOIN INSERTED I ON C.SODDH=I.SODDH WHERE I.SODDH=@SODDH) > 2

	BEGIN
	PRINT(N'Mỗi ngày mỗi khách hàng chỉ đặt tối đa 2 đơn hàng.')
	ROLLBACK TRANSACTION
	END
----------------------------------------
INSERT INTO CTDDH VALUES('DH004','SP01',11)
--2.Mỗi đơn đặt hàng có tổng số lượng sản phẩm không quá 100.
CREATE TRIGGER T2 ON CTDDH
FOR INSERT
AS
	DECLARE @SODDH VARCHAR(5),@SOLUONG FLOAT
	SELECT @SODDH=SODDH,@SOLUONG=SOLUONG FROM INSERTED
	IF(SELECT SOLUONG FROM CTDDH WHERE @SODDH=SODDH AND @SOLUONG=SOLUONG) > 100

	BEGIN
	PRINT(N'Mỗi đơn đặt hàng có tổng số lượng sản phẩm không quá 100.')
	ROLLBACK TRANSACTION
END
-----------------------------------------
INSERT INTO CTDDH VALUES('DH002','SP01',210)

--3.Đảm bảo rằng mỗi sản phẩm không bị lỗ hơn 50%.

Câu 3 Trigger :  Tính Giá thành sản phẩm. SO Sánh và cập nhật lại Giá Bán để không bị hơn 50%
Nếu giá bán < Giá thành sản xuấ : Cập nhật lại giá bán = giá sản xuất

/*
-------------CUSSOR
--1.Viết thủ tục liệt kê (theo thứ tự giảm dần của giá) X sản phẩm đầu tiên của sản phẩm có mã loại là Y (X, Y nhập khi gọi thủ tục) theo dạng sau:
--	Tên loại: Tủ 
--	Sản phẩm 1: Tủ Trang điểm – Mô tả: Cao 1.4m, rộng 2.2m – Giá: 1000000
--	Sản phẩm 2: Tủ DDA – Mô tả: Cao 1.6m, rộng 2.0m, cửa kiếng – Giá: 800000
CREATE PROC INSP(@X int,@Y VARCHAR(5))
AS 
	BEGIN
		DECLARE @TENLOAI NVARCHAR(30),@TENSP NVARCHAR(50),@MOTA NVARCHAR(50),@GIA NUMERIC(10,1),@ROW INT
		DECLARE INSP CURSOR FOR SELECT TOP 1 (@X) WITH TIES L.TENLOAI,S.TENSP,MOTA,GIA
								FROM LOAISP L JOIN SANPHAM S ON L.MALOAI=S.MALOAI
								WHERE L.MALOAI=@Y
								ORDER BY S.GIA DESC
		OPEN INSP
	FETCH NEXT FROM INSP INTO @TENLOAI,@TENSP,@MOTA,@GIA	-- Đọc dòng(hàng) đầu tiên
	PRINT N'TEN LOAI: '+@TENLOAI
	SET @ROW = 1 
	SET @X = IIF(@@CURSOR_ROWS < @X,@@CURSOR_ROWS,@X)	-- Nếu số dòng yêu cầu lớn hơn số dòng hiện có
	WHILE @@FETCH_STATUS = 0	-- Đọc dữ liệu thành công
	BEGIN
		WHILE @ROW <= @X
		BEGIN
			PRINT N'SAN PHAM '+CONVERT(VARCHAR(2),@ROW)+' : ' +@TENSP+' - '+@MOTA+' - GIA: '+CONVERT(VARCHAR(10),@GIA)
			FETCH NEXT FROM INSP INTO @TENLOAI,@TENSP,@MOTA,@GIA	--Đọc dòng tiếp theo
			SET @ROW = @ROW + 1
		END
	END
		CLOSE INSP	--Đóng con trỏ
		DEALLOCATE INSP
	END
--DROP PROC INSP
EXEC INSP 3 'L01'


--2.Viết thủ tục cập nhật giá cho bảng sản phẩm như sau: 
--	Những sản phẩm có lãi trên 30% thì giảm giá 10%
--	Những sản phẩm bị lỗ thì cập nhật giá bằng giá thành SX
--	Những sản phẩm khác thì tăng 5%


--3.Viết thủ tục in ra thống kê đặt hàng trong tháng X (nhập khi gọi thủ tục) có dạng như sau:
--	Ngày 15/3/2004
--		1-DH001: KH001, Tổng tiền: 15000000
--		2-DH002: KH016, Tổng tiền: 27500000
--	Ngày 16/3/2004
--		1-DH003: KH003, Tổng tiền: 8000000
--		2-DH004: KH012, Tổng tiền: 1100000


-----------BẢO MẬT PHÂN QUYỀN
--Tạo 3 user: Giám đốc, Kế toán và Nhân viên. Thực hiện phân quyền như sau:
--	Giám đốc: Toàn quyền trên toàn bộ CSDL
--	Kế toán: Chỉ được xem trên bảng SANPHAM, LOAISP. Các bảng khác toàn quyền.
--	Nhân viên: Không được truy cập bảng NGUYENLIEU, LAM. Các bảng khác được quyền xem, không được cập nhật.
*/