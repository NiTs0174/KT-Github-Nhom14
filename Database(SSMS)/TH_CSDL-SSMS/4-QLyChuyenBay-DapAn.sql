--TAO DATABASES
IF EXISTS (SELECT * FROM SYS.sysdatabases WHERE NAME = 'QLCB')
	DROP DATABASE QLCB
CREATE DATABASE QLCB
GO
USE QLCB
GO

CREATE TABLE CHUYENBAY
(
	 MACB CHAR(5) NOT NULL,
	 GADI VARCHAR(5),
	 GADEN VARCHAR(5),
	 DODAI INT,
	 GIODI TIME,
	 GIODEN TIME,
	 CHIPHI INT,
	 MAMB INT
 )

CREATE TABLE MAYBAY
(
	 MAMB INT NOT NULL,
	 LOAI VARCHAR(20),
	 TAMBAY INT
)

CREATE TABLE NHANVIEN
(
	 MANV VARCHAR(9) NOT NULL,
	 TEN NVARCHAR(50),
	 LUONG INT
)

CREATE TABLE CHUNGNHAN
(
	MANV VARCHAR(9) NOT NULL,
	MAMB INT NOT NULL,
)

--TAO KHOA CHINH
ALTER TABLE CHUYENBAY ADD CONSTRAINT PK_CHUYENBAY PRIMARY KEY (MACB)
ALTER TABLE MAYBAY ADD CONSTRAINT PK_MAYBAY PRIMARY KEY (MAMB)
ALTER TABLE NHANVIEN ADD CONSTRAINT PK_NHANVIEN PRIMARY KEY (MANV)
ALTER TABLE CHUNGNHAN ADD CONSTRAINT PK_CHUNGNHAN PRIMARY KEY (MANV,MAMB)

--TAO KHOA NGOAI
ALTER TABLE CHUNGNHAN ADD CONSTRAINT FK_CHUNGNHAN_NHANVIEN FOREIGN KEY(MANV) REFERENCES NHANVIEN(MANV)
ALTER TABLE CHUNGNHAN ADD CONSTRAINT FK_CHUNGNHAN_MAYBAY FOREIGN KEY(MAMB) REFERENCES MAYBAY(MAMB)
ALTER TABLE CHUYENBAY ADD CONSTRAINT FK_CHUYENBAY_MAYBAY FOREIGN KEY(MAMB) REFERENCES MAYBAY(MAMB)

--DỮ LIỆU TABLE MAYBAY
INSERT INTO MAYBAY VALUES (747,'Boeing 747 - 400',13488)
INSERT INTO MAYBAY VALUES (737,'Boeing 737 - 800',5413)
INSERT INTO MAYBAY VALUES (340,'Airbus A340 - 300',11392)
INSERT INTO MAYBAY VALUES (757,'Boeing 757 - 300',6416)
INSERT INTO MAYBAY VALUES (777,'Boeing 777 - 300',10306)
INSERT INTO MAYBAY VALUES (767,'Boeing 767 - 400ER',10360)
INSERT INTO MAYBAY VALUES (320,'Airbus A320',4168)
INSERT INTO MAYBAY VALUES (319,'Airbus A319',2888)
INSERT INTO MAYBAY VALUES (727,'Boeing 727',2406)
INSERT INTO MAYBAY VALUES (154,'Tupolev 154',6565)

--DỮ LIỆU TABLE NHANVIEN
INSERT INTO NHANVIEN VALUES (242518965,N'Trần Văn Sơn',120433)
INSERT INTO NHANVIEN VALUES (141582651,N'Đoàn Thị Mai',178345)
INSERT INTO NHANVIEN VALUES (11564812,N'Tôn Văn Quý',153972)
INSERT INTO NHANVIEN VALUES (567354612,N'Quan Cẩm Ly',256481)
INSERT INTO NHANVIEN VALUES (552455318,N'La Quế',101745)
INSERT INTO NHANVIEN VALUES (550156548,N'Nguyễn Thị Cẩm',205187)
INSERT INTO NHANVIEN VALUES (390487451,N'Lê Văn Luật',212156)
INSERT INTO NHANVIEN VALUES (274878974,N'Mai Quốc Minh',99890)
INSERT INTO NHANVIEN VALUES (254099823,N'Nguyễn Thị Quỳnh',24450)
INSERT INTO NHANVIEN VALUES (356187925,N'Nguyễn Vinh Bảo',44740)
INSERT INTO NHANVIEN VALUES (355548984,N'Trần Thị Hoài An',212156)
INSERT INTO NHANVIEN VALUES (310454876,N'Tạ Văn Đồ',212156)
INSERT INTO NHANVIEN VALUES (489456522,N'Nguyễn Thị Quý Linh',127984)
INSERT INTO NHANVIEN VALUES (489221823,N'Bùi Quốc Chinh',23980)
INSERT INTO NHANVIEN VALUES (548977562,N'Lê Văn Quý',84476)
INSERT INTO NHANVIEN VALUES (310454877,N'Trần Văn Hạo',33546)
INSERT INTO NHANVIEN VALUES (142519864,N'Nguyển Thị Xuân Đào',227489)
INSERT INTO NHANVIEN VALUES (269734834,N'Trương Tuấn Anh',289950)
INSERT INTO NHANVIEN VALUES (287321212,N'Dương Văn Minh',48090)
INSERT INTO NHANVIEN VALUES (552455348,N'Bùi Thị Dung',92013)
INSERT INTO NHANVIEN VALUES (248965255,N'Trần Thị Ba',43723)
INSERT INTO NHANVIEN VALUES (159542516,N'Lê Văn Kỳ',48250)
INSERT INTO NHANVIEN VALUES (348121549,N'Nguyễn Văn Thanh',32899)
INSERT INTO NHANVIEN VALUES (574489457,N'Bùi Văn Lập',20)

--DỮ LIỆU TABLE CHUNGNHAN
INSERT INTO CHUNGNHAN VALUES (567354612,747)
INSERT INTO CHUNGNHAN VALUES (567354612,737)
INSERT INTO CHUNGNHAN VALUES (567354612,757)
INSERT INTO CHUNGNHAN VALUES (567354612,777)
INSERT INTO CHUNGNHAN VALUES (567354612,767)
INSERT INTO CHUNGNHAN VALUES (567354612,727)
INSERT INTO CHUNGNHAN VALUES (567354612,340)
INSERT INTO CHUNGNHAN VALUES (552455318,737)
INSERT INTO CHUNGNHAN VALUES (552455318,319)
INSERT INTO CHUNGNHAN VALUES (552455318,747)
INSERT INTO CHUNGNHAN VALUES (552455318,767)
INSERT INTO CHUNGNHAN VALUES (390487451,340)
INSERT INTO CHUNGNHAN VALUES (390487451,320)
INSERT INTO CHUNGNHAN VALUES (390487451,319)
INSERT INTO CHUNGNHAN VALUES (274878974,757)
INSERT INTO CHUNGNHAN VALUES (274878974,767)
INSERT INTO CHUNGNHAN VALUES (355548984,154)
INSERT INTO CHUNGNHAN VALUES (310454876,154)
INSERT INTO CHUNGNHAN VALUES (142519864,747)
INSERT INTO CHUNGNHAN VALUES (142519864,757)
INSERT INTO CHUNGNHAN VALUES (142519864,777)
INSERT INTO CHUNGNHAN VALUES (142519864,767)
INSERT INTO CHUNGNHAN VALUES (142519864,737)
INSERT INTO CHUNGNHAN VALUES (142519864,340)
INSERT INTO CHUNGNHAN VALUES (142519864,320)
INSERT INTO CHUNGNHAN VALUES (269734834,747)
INSERT INTO CHUNGNHAN VALUES (269734834,737)
INSERT INTO CHUNGNHAN VALUES (269734834,340)
INSERT INTO CHUNGNHAN VALUES (269734834,757)
INSERT INTO CHUNGNHAN VALUES (269734834,777)
INSERT INTO CHUNGNHAN VALUES (269734834,767)
INSERT INTO CHUNGNHAN VALUES (269734834,320)
INSERT INTO CHUNGNHAN VALUES (269734834,319)
INSERT INTO CHUNGNHAN VALUES (269734834,727)
INSERT INTO CHUNGNHAN VALUES (269734834,154)
INSERT INTO CHUNGNHAN VALUES (242518965,737)
INSERT INTO CHUNGNHAN VALUES (242518965,757)
INSERT INTO CHUNGNHAN VALUES (141582651,737)
INSERT INTO CHUNGNHAN VALUES (141582651,757)
INSERT INTO CHUNGNHAN VALUES (141582651,767)
INSERT INTO CHUNGNHAN VALUES (11564812,737)
INSERT INTO CHUNGNHAN VALUES (11564812,757)
INSERT INTO CHUNGNHAN VALUES (574489457,154)

--DỮ LIỆU TABLE CHUYẾN BAY
INSERT INTO CHUYENBAY VALUES ('VN431','SGN','CAH',3693,'05:55','06:55',236,747)
INSERT INTO CHUYENBAY VALUES ('VN320','SGN','DAD',2798,'06:00','07:10',221,737)
INSERT INTO CHUYENBAY VALUES ('VN464','SGN','DLI',2002,'07:20','08:05',225,340)
INSERT INTO CHUYENBAY VALUES ('VN216','SGN','DIN',4170,'10:30','02:20',262,757)
INSERT INTO CHUYENBAY VALUES ('VN280','SGN','HPH',11979,'06:00','08:00',1279,777)
INSERT INTO CHUYENBAY VALUES ('VN254','SGN','HUI',8765,'06:40','08:00',781,767)
INSERT INTO CHUYENBAY VALUES ('VN338','SGN','BMV',4081,'03:25','04:25',375,320)
INSERT INTO CHUYENBAY VALUES ('VN440','SGN','BMV',4081,'06:30','07:30',426,319)
INSERT INTO CHUYENBAY VALUES ('VN651','DAD','SGN',2798,'07:30','08:00',221,727)
INSERT INTO CHUYENBAY VALUES ('VN276','DAD','CXR',1283,'09:00','12:00',203,154)
INSERT INTO CHUYENBAY VALUES ('VN374','HAN','VII',510,'11:40','01:25',120,747)
INSERT INTO CHUYENBAY VALUES ('VN375','VII','CXR',752,'02:15','04:00',181,737)
INSERT INTO CHUYENBAY VALUES ('VN269','HAN','CXR',1262,'02:10','03:50',202,340)
INSERT INTO CHUYENBAY VALUES ('VN315','HAN','DAD',134,'11:45','01:00',112,757)
INSERT INTO CHUYENBAY VALUES ('VN317','HAN','UIH',827,'03:00','04:15',190,777)
INSERT INTO CHUYENBAY VALUES ('VN741','HAN','PXU',395,'06:30','08:30',120,767)
INSERT INTO CHUYENBAY VALUES ('VN474','PXU','PQC',1586,'08:40','11:20',102,747)
INSERT INTO CHUYENBAY VALUES ('VN476','UIH','PQC',485,'09:15','11:50',117,777)

--1)	CHO BIẾT CÁC CHUYẾN BAY ĐI ĐÀ LẠT (DAD).
SELECT * FROM CHUYENBAY WHERE GADEN = 'DAD'

--2)	CHO BIẾT CÁC LOẠI MÁY BAY CÓ TẦM BAY LỚN HƠN 10.000 KM.
SELECT *
FROM MAYBAY
WHERE  TAMBAY > 10000

--3)	TÌM CÁC NHÂN VIÊN CÓ LƯƠNG NHỎ HƠN 10.000
SELECT *
FROM NHANVIEN
WHERE  Luong < 10000

--4)	CHO BIẾT CÁC CHUYẾN BAY CÓ ĐỘ DÀI ĐƯỜNG BAY NHỎ HƠN 10.000KM VÀ LỚN HƠN 8.000KM.
SELECT *
FROM CHUYENBAY
WHERE DoDai > 8000 AND DoDai < 10000

--5)	CHO BIẾT CÁC CHUYẾN BAY XUẤT PHÁT TỪ SÀI GÒN (SGN) ĐI BAN MÊ THUỘC (BMV).
SELECT *
FROM CHUYENBAY
WHERE GADEN = 'BMV' AND GADI = 'SGN'

--6)	CÓ BAO NHIÊU CHUYẾN BAY XUẤT PHÁT TỪ SÀI GÒN (SGN)
SELECT SOCHUYENBAYSGN = COUNT('SGN')
FROM MAYBAY
WHERE LOAI LIKE 'BOEING%'

--4)	CÓ BAO NHIÊU LOẠI MÁY BÁY BOEING.
SELECT COUNT(*) SOLOAIBOEING FROM MAYBAY WHERE LOAI LIKE 'BOEING%'

--5)	CHO BIẾT TỔNG SỐ LƯƠNG PHẢI TRẢ CHO CÁC NHÂN VIÊN.
SELECT SUM(LUONG) TONGSOLUONG FROM NHANVIEN

--6)	CHO BIẾT MÃ SỐ CỦA CÁC PHI CÔNG VỪA LÁI ĐƯỢC BOEING VỪA LÁI ĐƯỢC AIRBUS.
SELECT DISTINCT MANV
FROM CHUNGNHAN A, MAYBAY B
WHERE A.MAMB=B.MAMB AND LOAI LIKE 'BOEING%' AND MANV IN (SELECT MANV
                        FROM CHUNGNHAN A, MAYBAY B
                        WHERE A.MAMB=B.MAMB AND LOAI LIKE 'AIRBUS%')

--7)	CHO BIẾT CÁC CHUYẾN BAY CÓ THỂ ĐƯỢC THỰC HIỆN BỞI MÁY BAY AIRBUS A320.
SELECT * FROM CHUYENBAY A, MAYBAY B WHERE A.MAMB=B.MAMB AND LOAI LIKE 'AIRBUS A320'

--8)	VỚI MỖI LOẠI MÁY BAY CÓ PHI CÔNG LÁI CHO BIẾT MÃ SỐ, LOẠI MÁY BÁY VÀ TỔNG SỐ PHI CÔNG CÓ THỂ LÁI LOẠI MÁY BAY ĐÓ.
SELECT A.MAMB, A.LOAI, COUNT(MANV) SONVCOTHELAI
FROM MAYBAY A, CHUNGNHAN B
WHERE A.MAMB=B.MAMB 
GROUP BY A.MAMB, A.LOAI

--9)	GIẢ SỬ MỘT HÀNH KHÁCH MUỐN ĐI THẲNG TỪ GA A ĐẾN GA B RỒI QUAY TRỞ VỀ GA A. CHO BIẾT CÁC ĐƯỜNG BAY NÀO CÓ THỂ ĐÁP ỨNG YÊU CẦU NÀY.
SELECT A.MACB, A.GADI, A.GADEN,A.GIODEN, B.MACB, B.GADI, B.GADEN, B.GIODI
FROM CHUYENBAY A, CHUYENBAY B
WHERE A.GADI=B.GADEN AND A.GADEN=B.GADI AND A.GIODEN<B.GIODI

--10)	VỚI MỖI GA CÓ CHUYẾN BAY XUẤT PHÁT TỪ ĐÓ CHO BIẾT CÓ BAO NHIÊU CHUYẾN BAY KHỞI HÀNH TỪ GA ĐÓ.
SELECT GADI, COUNT(MAMB) SOCHUYENKHOIHANH
FROM CHUYENBAY
GROUP BY GADI

--11)	CHO BIẾT MÃ SỐ CỦA CÁC PHI CÔNG CHỈ LÁI ĐƯỢC 3 LOẠI MÁY BAY.
SELECT A.MANV, TEN
FROM NHANVIEN A, CHUNGNHAN B
WHERE A.MANV=B.MANV
GROUP BY A.MANV, TEN
HAVING COUNT(MAMB)=3

--12)	VỚI MỖI PHI CÔNG CÓ THỂ LÁI NHIỀU HƠN 3 LOẠI MÁY BAY, CHO BIẾT MÃ SỐ PHI CÔNG VÀ TẦM BAY LỚN NHẤT CỦA 
--CÁC LOẠI MÁY BAY MÀ PHI CÔNG ĐÓ CÓ THỂ LÁI.

SELECT C.MANV,H.TEN, TAMBAY
FROM CHUNGNHAN C, MAYBAY D , (SELECT A.MANV, TEN
		FROM NHANVIEN A, CHUNGNHAN B, MAYBAY E
		WHERE A.MANV=B.MANV AND B.MAMB=E.MAMB 
		GROUP BY A.MANV, TEN
		HAVING COUNT(B.MAMB)>3) AS H
WHERE C.MAMB=D.MAMB AND H.MANV=C.MANV AND TAMBAY >= ALL (
												SELECT TAMBAY FROM MAYBAY E, 
												CHUNGNHAN G
												WHERE D.MAMB=G.MAMB AND G.MANV=C.MANV)

--13)	CHO BIẾT MÃ SỐ CỦA CÁC PHI CÔNG CÓ THỂ LÁI ĐƯỢC NHIỀU LOẠI MÁY BAY NHẤT.
SELECT TOP 1 WITH TIES MANV, COUNT(MAMB) SOMAYBAYLAI
FROM CHUNGNHAN
GROUP BY MANV
ORDER BY SOMAYBAYLAI DESC

--14)	TÌM CÁC NHÂN VIÊN KHÔNG PHẢI LÀ PHI CÔNG.
SELECT * FROM NHANVIEN
WHERE MANV NOT IN (SELECT MANV FROM CHUNGNHAN)

--15)	TÌM CÁC CHUYẾN BAY CÓ THỂ ĐƯỢC LÁI BỞI CÁC PHI CÔNG CÓ LƯƠNG LỚN HƠN 100,000.
SELECT DISTINCT MACB
FROM CHUYENBAY A, MAYBAY B, CHUNGNHAN C, NHANVIEN D
WHERE A.MAMB=B.MAMB AND B.MAMB=C.MAMB AND C.MANV=D.MANV AND LUONG >100000

--16)	CHO BIẾT MÃ SỐ CỦA CÁC NHÂN VIÊN CÓ LƯƠNG CAO THỨ NHÌ.
SELECT TOP 1 WITH TIES MANV, LUONG
FROM NHANVIEN
WHERE MANV NOT IN (SELECT MANV FROM NHANVIEN WHERE LUONG=(SELECT MAX(LUONG) FROM NHANVIEN))
ORDER BY LUONG DESC

--17)	CHO BIẾT MÃ SỐ CỦA CÁC NHÂN VIÊN CÓ LƯƠNG CAO THỨ NHẤT HOẶC THỨ NHÌ.
SELECT TOP 2 WITH TIES MANV, LUONG
FROM NHANVIEN
ORDER BY LUONG DESC

--18)	CHO BIẾT TÊN VÀ LƯƠNG CỦA CÁC NHÂN VIÊN KHÔNG PHẢI LÀ PHI CÔNG VÀ CÓ LƯƠNG LỚN HƠN LƯƠNG TRUNG BÌNH CỦA TẤT CẢ CÁC PHI CÔNG.
SELECT * FROM NHANVIEN
WHERE MANV NOT IN (SELECT MANV FROM CHUNGNHAN) AND LUONG > (
				SELECT AVG(B.LUONG) 
				FROM CHUNGNHAN A, NHANVIEN B 
				WHERE B.MANV=A.MANV) 

-- KHÔNG CÓ AI CÓ MỨC LƯƠNG LƠN HƠN

--19)	VỚI MỖI NHÂN VIÊN CHO BIẾT MÃ SỐ, TÊN NHÂN VIÊN VÀ TỔNG SỐ LOẠI MÁY BAY MÀ NHÂN VIÊN ĐÓ CÓ THỂ LÁI.
SELECT A.MANV, TEN, COUNT(MAMB) SOLOAIMB
FROM NHANVIEN A, CHUNGNHAN B
WHERE A.MANV=B.MANV
GROUP BY  A.MANV, TEN

--20)	VỚI MỖI LOẠI MÁY BAY CÓ TẦM BAY TRÊN 3200KM, CHO BIẾT TÊN CỦA LOẠI MÁY BAY VÀ LƯƠNG TRUNG BÌNH 
--CỦA CÁC PHI CÔNG CÓ THỂ LÁI LOẠI MÁY BAY ĐÓ.
SELECT A.MAMB, LOAI, AVG(LUONG) LUONGTRUNGBINH
FROM MAYBAY A, CHUNGNHAN B, NHANVIEN C
WHERE A.MAMB=B.MAMB AND B.MANV=C.MANV AND TAMBAY>3200
GROUP BY A.MAMB, LOAI

--21)	VỚI MỖI LOẠI MÁY BAY CHO BIẾT LOẠI MÁY BAY VÀ TỔNG SỐ NHÂN VIÊN KHÔNG THỂ LÁI LOẠI MÁY BAY ĐÓ.
SELECT C.LOAI, SONVKHONGLAI=(SELECT COUNT(*) FROM NHANVIEN)-SONHANVIENCOTHELAI
FROM MAYBAY C, ( SELECT A.MAMB, LOAI, COUNT(B.MANV) SONHANVIENCOTHELAI
                 FROM MAYBAY A, CHUNGNHAN B
                 WHERE A.MAMB=B.MAMB 
                 GROUP BY A.MAMB, LOAI) D
WHERE C.LOAI=D.LOAI

-- 22)	VỚI MỖI PHI CÔNG CHO BIẾT MÃ SỐ, TÊN PHI CÔNG VÀ TỔNG SỐ CHUYẾN BAY XUẤT PHÁT TỪ SÀI GÒN MÀ PHI CÔNG ĐÓ CÓ THỂ LÁI.
SELECT A.MANV, TEN, COUNT(MACB) XUATPHATSG
FROM NHANVIEN A, CHUNGNHAN B, MAYBAY C, CHUYENBAY D
WHERE A.MANV=B.MANV AND B.MAMB=C.MAMB AND C.MAMB=D.MAMB AND GADI='SGN'
GROUP BY A.MANV, TEN

--23)	MỘT HÀNH KHÁCH MUỐN ĐI TỪ HÀ NỘI (HAN) ĐẾN NHA TRANG (CXR) MÀ KHÔNG PHẢI ĐỔI CHUYẾN BAY QUÁ MỘT LẦN. 
--CHO BIẾT MÃ CHUYẾN BAY VÀ THỜI GIAN KHỞI HÀNH TỪ HÀ NỘI NẾU HÀNH KHÁCH MUỐN ĐẾN NHA TRANG TRƯỚC 16:00.
SELECT MACB, GIODI
FROM CHUYENBAY
WHERE GADI='HAN' AND GADEN='CXR' AND GIODEN < '16:00'
UNION
SELECT A.MACB, A.GIODI
FROM CHUYENBAY A, CHUYENBAY B
WHERE A.GADI='HAN' AND A.GADEN=B.GADI AND B.GADEN='CXR' AND A.GIODEN<B.GIODI AND B.GIODEN < '16:00' 

--24)	CHO BIẾT TÊN CÁC PHI CÔNG CHỈ LÁI CÁC LOẠI MÁY BAY CÓ TẦM BAY XA HƠN 3200KM.
SELECT DISTINCT A.MANV, A.TEN
FROM NHANVIEN A, CHUNGNHAN B, MAYBAY C
WHERE A.MANV=B.MANV AND B.MAMB=C.MAMB AND C.TAMBAY>3200

--25)	CHO BIẾT TÊN CÁC PHI CÔNG CHỈ LÁI CÁC LOẠI MÁY BAY CÓ TẦM BAY XA HƠN 3200KM VÀ MỘT TRONG SỐ ĐÓ LÀ BOEING.
SELECT DISTINCT A.MANV, A.TEN
FROM NHANVIEN A, CHUNGNHAN B, MAYBAY C
WHERE A.MANV=B.MANV AND B.MAMB=C.MAMB AND C.TAMBAY>3200 AND C.LOAI LIKE 'BOEING%'

--26)	TÌM CÁC PHI CÔNG CÓ THỂ LÁI TẤT CẢ CÁC LOẠI MÁY BAY.
SELECT A.MANV, A.TEN
FROM NHANVIEN A, CHUNGNHAN B
WHERE A.MANV=B.MANV
GROUP BY A.MANV, A.TEN
HAVING COUNT(B.MAMB)=(SELECT COUNT(MAMB)FROM MAYBAY)