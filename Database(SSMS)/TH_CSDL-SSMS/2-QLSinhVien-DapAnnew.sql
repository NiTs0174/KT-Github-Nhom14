
--


﻿
-- TẠO DATABASE
CREATE DATABASE QLSV
on
(name='QLSV_DATA',filename='C:\QLSV.MDF')
log on
(name='QLSV_LOG', filename='C:\QLSV.LDF')
GO
USE QLSV

go

SET DATEFORMAT DMY;
-- TẠO TABLE
CREATE TABLE LOP
(
	MALOP	CHAR(7) NOT NULL PRIMARY KEY(MALOP), 
	TENLOP	NVARCHAR(50),
	SISO	TINYINT CHECK ( SISO >0)
)

CREATE TABLE MONHOC
(
	MAMH	CHAR(6) NOT NULL PRIMARY KEY (MAMH),
	TENMH	NVARCHAR(50),
	TCLT	TINYINT,	
	TCTH	TINYINT
)

CREATE TABLE SINHVIEN
(
	MSSV	CHAR(6) NOT NULL PRIMARY KEY (MSSV),
	HOTEN	NVARCHAR(50),
	NTNS	DATE,
	PHAI	BIT CHECK (PHAI = 0 OR PHAI = 1) DEFAULT 1 ,
	MALOP	CHAR(7) FOREIGN KEY  REFERENCES LOP (MALOP)
)

CREATE TABLE DIEMSV
(
	MSSV	CHAR(6) NOT NULL FOREIGN KEY  REFERENCES SINHVIEN (MSSV),
	MAMH	CHAR(6) NOT NULL,
	DIEM	DECIMAL(3,1) CHECK ( DIEM>=0 AND DIEM <=10) DEFAULT NULL,
	PRIMARY KEY (MSSV,MAMH),
	CONSTRAINT FK_DIEMSV_MAMH FOREIGN KEY (MAMH) REFERENCES MONHOC (MAMH)
)

-- TẠO KHÓA CHÍNH

--ALTER TABLE LOP
--	ADD CONSTRAINT PK_LOP PRIMARY KEY(MALOP)
--ALTER TABLE MONHOC
--	ADD CONSTRAINT PK_MONHOC PRIMARY KEY (MAMH)
--ALTER TABLE SINHVIEN
--	ADD CONSTRAINT PK_SINHVIEN PRIMARY KEY (MSSV)
--ALTER TABLE DIEMSV
--	ADD CONSTRAINT PK_DIEMSV PRIMARY KEY (MSSV,MAMH)

-- TẠO KHÓA NGOẠI
--ALTER TABLE SINHVIEN
--	ADD CONSTRAINT FK_SINHVIEN_MALOP FOREIGN KEY (MALOP) REFERENCES LOP (MALOP)
--ALTER TABLE DIEMSV
--	ADD CONSTRAINT FK_DIEMSV_MSSV FOREIGN KEY (MSSV) REFERENCES SINHVIEN (MSSV)
--ALTER TABLE DIEMSV
--	ADD CONSTRAINT FK_DIEMSV_MAMH FOREIGN KEY (MAMH) REFERENCES MONHOC (MAMH)

-- rang buoc 
-- SI SO >0

--ALTER TABLE LOP
--	ADD CONSTRAINT CHK_LOP_SISO CHECK ( SISO >0)
--ALTER TABLE SINHVIEN
--	ADD CONSTRAINT CHK_SINHVIEN_PHAI CHECK (PHAI = 0 OR PHAI = 1), -- 0 HOAC 1
--		CONSTRAINT DEF_SINHVIEN_PHAI DEFAULT 1 FOR PHAI -- GIA TRI MAC DINH
--ALTER TABLE DIEMSV
--	ADD CONSTRAINT CHK_DIEMSV_DIEM CHECK ( DIEM>=0 AND DIEM <=10),
--		CONSTRAINT DEF_DIEMSV_DIEM DEFAULT NULL FOR DIEM

 -- NHẬP LIỆU

-- LOP:

INSERT INTO LOP VALUES ('18DTH01',N'CNTT Khóa 18,Lớp 1',50)
INSERT INTO LOP VALUES ('18DTH02',N'CNTT Khóa 18,Lớp 1',45)
INSERT INTO LOP VALUES ('19DTH01',N'CNTT Khóa 19,Lớp 1',55)
INSERT INTO LOP VALUES ('19DTH02',N'CNTT Khóa 19,Lớp 2',50)
INSERT INTO LOP VALUES ('19DTH03',N'CNTT Khóa 19,Lớp 3',40)
SELECT * FROM LOP

-- MONHOC
INSERT INTO MONHOC VALUES ('COS201',N'Kỹ thuật lập trình',2,1)
INSERT INTO MONHOC VALUES ('COS202',N'Lý thuyết đồ thị',2,1)
INSERT INTO MONHOC VALUES ('COS203',N'CSDL và Quản Trị CSDL',3,0)
INSERT INTO MONHOC VALUES ('COS204',N'Phân tích thiết kế hệ thống',3,0)
INSERT INTO MONHOC VALUES ('COS205',N'CSDL phân tán',3,0)
SELECT * FROM MONHOC

-- chinh ngay
 --alter session set NLS_DATE_FORMAT='dd/mm/yyyy'

-- SINHVIEN
INSERT INTO SINHVIEN VALUES ('170001',N'Lê Hoài An','12/10/1999',0,'18DTH01')
INSERT INTO SINHVIEN VALUES ('180002',N'Nguyễn Thị Hòa Bình','11/2/2000',0,'18DTH01')
INSERT INTO SINHVIEN VALUES ('180003',N'Phạm Tường Châu','06/06/2000' ,1,'18DTH02')
INSERT INTO SINHVIEN VALUES ('180004',N'Trần Công Danh','01/3/2000' ,1,'19DTH01')
SELECT * FROM SINHVIEN 

--DIEMSV

INSERT INTO DIEMSV VALUES ('170001','COS201',10)
INSERT INTO DIEMSV VALUES ('170001','COS202',10)
INSERT INTO DIEMSV VALUES ('170001','COS203',10)
INSERT INTO DIEMSV VALUES ('170001','COS204',10)
INSERT INTO DIEMSV VALUES ('170001','COS205',10)
INSERT INTO DIEMSV VALUES ('180002','COS201',3.5)
INSERT INTO DIEMSV VALUES ('180002','COS202',7)
INSERT INTO DIEMSV VALUES ('180003','COS201',8.5)
INSERT INTO DIEMSV VALUES ('180003','COS202',2)
INSERT INTO DIEMSV VALUES ('180003','COS203',6.5)
INSERT INTO DIEMSV VALUES ('180004','COS201',8)
INSERT INTO DIEMSV VALUES ('180004','COS204',NULL)
SELECT * FROM DIEMSV

--TRUY VẤN
--Thực hiện các câu hỏi sau bằng ngôn ngữ SQL:
--1-	Thêm một dòng mới vào bảng SINHVIEN với giá trị:
--190001	Đào Thị Tuyết Hoa	08/03/2001	0	19DTH02
INSERT INTO SINHVIEN VALUES ('190001',N'Đào Thị Tuyết Hoa','03/08/2001',0,'19DTH02')

--2-	Hãy đổi tên môn học ‘Lý thuyết đồ thị ’thành ‘Toán rời rạc’.
UPDATE MONHOC
SET TENMH = N'Toán rời rạc'
WHERE TENMH=N'Lý thuyết đồ thị'

--3-	Hiển thị tên các môn học không có thực hành.
SELECT * 
FROM MONHOC
WHERE TCTH =0

--4-	Hiển thị tên các môn học vừa có lý thuyết, vừa có thực hành.
SELECT * 
FROM MONHOC
WHERE TCLT > 0 AND TCTH >0

TRUY VẤN
--Thực hiện các câu hỏi sau bằng ngôn ngữ SQL:
--1-	Thêm một dòng mới vào bảng SINHVIEN với giá trị:
--190001	Đào Thị Tuyết Hoa	08/03/2001	0	19DTH02
INSERT INTO SINHVIEN VALUES ('190001',N'Đào Thị Tuyết Hoa','03/08/2001',0,'19DTH02')

--2-	Hãy đổi tên môn học ‘Lý thuyết đồ thị ’thành ‘Toán rời rạc’.
UPDATE MONHOC
SET TENMH = N'Toán rời rạc'
WHERE TENMH=N'Lý thuyết đồ thị'

--3-	Hiển thị tên các môn học không có thực hành.
SELECT * 
FROM MONHOC
WHERE TCTH =0

--4-	Hiển thị tên các môn học vừa có lý thuyết, vừa có thực hành.
SELECT * 
FROM MONHOC
WHERE TCLT > 0 AND TCTH >0

--5-	In ra tên các môn học có ký tự đầu của tên là chữ ‘C’.
SELECT *
FROM MONHOC
WHERE TENMH LIKE N'C%'

--6-	Liệt kê thông tin những sinh viên mà họ chứa chữ ‘Thị’.
SELECT * 
FROM SINHVIEN
WHERE HOTEN LIKE N'%Thị%'

--7-	In ra 2 lớp có sĩ số đông nhất (bằng nhiều cách). Hiển thị: Mã lớp, Tên lớp, Sĩ số. Nhận xét?
SELECT TOP 1 WITH TIES L.MALOP,TENLOP,COUNT(MSSV) SISO
FROM LOP L, SINHVIEN S
WHERE L.MALOP = S.MALOP
GROUP BY L.MALOP,TENLOP
ORDER BY COUNT(MSSV) DESC

--8-	In danh sách SV theo từng lớp: MSSV, Họ tên SV, Năm sinh, Phái (Nam/Nữ).
SELECT MSSV,HOTEN,CASE PHAI
							WHEN 1 THEN 'NAM'
							ELSE N'NỮ'
				  END AS GIOITINH, MALOP
FROM SINHVIEN
ORDER BY MALOP ASC

--9-	Cho biết những sinh viên có tuổi ≥ 20, thông tin gồm: Họ tên sinh viên, Ngày sinh, Tuổi.
SELECT MSSV,HOTEN,NTNS ,TUOI = YEAR(SYSDATETIME())-YEAR(NTNS) --AS TUOI
FROM SINHVIEN
WHERE YEAR(SYSDATETIME())-YEAR(NTNS)>=20

--10-	Liệt kê tên các môn học SV đã dự thi nhưng chưa có điểm.
SELECT *
FROM MONHOC
WHERE MAMH IN ( SELECT MAMH FROM DIEMSV WHERE DIEM IS NULL)

select MONHOC.*
from MONHOC,DIEMSV
where MONHOC.MAMH = DIEMSV.MAMH and DIEM is null



--11-	Liệt kê kết quả học tập của SV có mã số 170001. Hiển thị: MSSV, HoTen, TenMH, Diem.
SELECT S.MSSV,HOTEN,TENMH, DIEM
FROM SINHVIEN S,DIEMSV D,MONHOC M
WHERE S.MSSV = D.MSSV AND D.MAMH = M.MAMH AND S.MSSV = '170001'

--12-	Liệt kê tên sinh viên và mã môn học mà sv đó đăng ký với điểm trên 7 điểm.
SELECT S.MSSV,HOTEN,TENMH, DIEM
FROM SINHVIEN S,DIEMSV D,MONHOC M
WHERE S.MSSV = D.MSSV AND D.MAMH = M.MAMH AND DIEM >=7

--13-	Liệt tên môn học cùng số lượng SV đã học và đã có điểm.
SELECT M.MAMH,TENMH,COUNT(S.MSSV) AS SLDK
FROM SINHVIEN S, DIEMSV D, MONHOC M
WHERE S.MSSV = D.MSSV AND D.MAMH = M.MAMH AND DIEM>0
GROUP BY M.MAMH,TENMH

--14-	Liệt kê tên SV và điểm trung bình của SV đó.
SELECT S.MSSV,HOTEN,AVG(DIEM) AS DIEMTB
FROM SINHVIEN S,DIEMSV D
WHERE S.MSSV = D.MSSV
GROUP BY S.MSSV,HOTEN

--15-	Liệt kê tên sinh viên đạt điểm cao nhất của môn học ‘Kỹ thuật lập trình’.
SELECT *
FROM SINHVIEN S,DIEMSV D,MONHOC M
WHERE S.MSSV = D.MSSV AND M.MAMH = D.MAMH AND TENMH =N'Kỹ thuật lập trình' AND DIEM = (
			SELECT MAX(DIEM)
			FROM DIEMSV D,MONHOC M
			WHERE D.MAMH = M.MAMH AND TENMH =N'Kỹ thuật lập trình')

--16-	Liệt kê tên SV có điểm trung bình cao nhất.
SELECT TOP 1 WITH TIES S.MSSV,HOTEN,AVG(DIEM) AS DIEMTB
FROM SINHVIEN S,DIEMSV D
WHERE S.MSSV = D.MSSV
GROUP BY S.MSSV,HOTEN
ORDER BY AVG(DIEM) DESC

--17-	Liệt kê tên SV chưa học môn ‘Toán rời rạc’.
SELECT * 
FROM SINHVIEN
WHERE MSSV NOT IN(
					SELECT D.MSSV
					FROM DIEMSV D,MONHOC M
					WHERE D.MAMH = M.MAMH AND TENMH =N'Toán rời rạc')


--18-	Cho biết sinh viên có năm sinh cùng với sinh viên tên ‘Danh’.
SELECT *
FROM SINHVIEN
WHERE YEAR(NTNS) = (
					SELECT YEAR(NTNS)
					FROM SINHVIEN
					WHERE HOTEN LIKE N'%Danh')

SELECT (PHAI) FROM SINHVIEN
--19-	Cho biết tổng sinh viên và tổng số sinh viên nữ.
SELECT COUNT(S.MSSV) AS SLSINHVIEN,SUM(CASE PHAI WHEN 1 THEN 1 ELSE 0 END) AS SLNU
FROM SINHVIEN S


--20-	Cho biết danh sách các sinh viên rớt ít nhất 1 môn.
SELECT s.MSSV,HOTEN,NTNS,DIEM
FROM SINHVIEN S,DIEMSV D
WHERE S.MSSV = D.MSSV AND DIEM<5

--21-	Cho biết MSSV, Họ tên SV đã học và có điểm ít nhất 3 môn.
SELECT S.MSSV,HOTEN,COUNT(MAMH) AS SOMON
FROM SINHVIEN S,DIEMSV D
WHERE S.MSSV = D.MSSV AND DIEM>0
GROUP BY S.MSSV,HOTEN
HAVING COUNT(MAMH)>=3

--22-	In danh sách sinh viên có điểm môn ‘Kỹ thuật lập trình’ cao nhất theo từng lớp.
SELECT s.MSSV,HOTEN,NTNS,DIEM,MALOP
FROM SINHVIEN S,DIEMSV D,MONHOC M
WHERE S.MSSV = D.MSSV AND D.MAMH = M.MAMH AND TENMH =N'Kỹ thuật lập trình' AND 
	DIEM>=ALL(
				SELECT DIEM	
				FROM SINHVIEN S1,DIEMSV D1,MONHOC M1
				WHERE D1.MAMH = M1.MAMH AND  S1.MSSV = D1.MSSV AND TENMH = N'Kỹ thuật lập trình' 
							AND S.MALOP =S1.MALOP 
				)
--23-	In danh sách sinh viên có điểm cao nhất theo từng môn, từng lớp.
SELECT s.MSSV,HOTEN,NTNS,DIEM,MALOP,TENMH
FROM SINHVIEN S,DIEMSV D,MONHOC M
WHERE S.MSSV = D.MSSV AND D.MAMH = M.MAMH  AND 
	DIEM>=ALL(
				SELECT DIEM	
				FROM SINHVIEN S1,DIEMSV D1,MONHOC M1
				WHERE D1.MAMH = M1.MAMH AND  S1.MSSV = D1.MSSV  
							AND S.MALOP =S1.MALOP AND M.MAMH = M1.MAMH 
				)



--24-	Cho biết những sinh viên đạt điểm cao nhất của từng môn.
SELECT s.MSSV,HOTEN,NTNS,DIEM,MALOP,TENMH
FROM SINHVIEN S,DIEMSV D,MONHOC M
WHERE S.MSSV = D.MSSV AND D.MAMH = M.MAMH  AND 
	DIEM>=ALL(
				SELECT MAX(DIEM)	
				FROM SINHVIEN S1,DIEMSV D1,MONHOC M1
				WHERE D1.MAMH = M1.MAMH AND  S1.MSSV = D1.MSSV  
							AND M.MAMH = M1.MAMH 
				GROUP BY M1.MAMH
				)

SELECT * FROM MONHOC

--25-	Cho biết MSSV, Họ tên SV chưa đăng ký học môn nào.
SELECT *
FROM SINHVIEN
WHERE MSSV NOT IN
	(	SELECT MSSV 
		FROM DIEMSV
	)
	
--26-	Danh sách sinh viên có tất cả các điểm đều 10.

SELECT s.MSSV,HOTEN,MAMH,DIEM
FROM SINHVIEN S,DIEMSV D
WHERE S.MSSV = D.MSSV AND S.MSSV IN
(
	SELECT MSSV
	FROM DIEMSV
	group by MSSV
	having min(DIEM) = 10
)

--27-	Đếm số sinh viên nam, nữ theo từng lớp.
SELECT L.MALOP,TENLOP,SUM(CASE PHAI WHEN 1 THEN 1 ELSE 0 END) AS SISONAM, SUM(CASE PHAI WHEN 1 THEN 0 ELSE 1 END) AS SOLUONGNU
FROM SINHVIEN S, LOP L
WHERE L.MALOP = S.MALOP
GROUP BY L.MALOP,TENLOP

--28-	Cho biết những sinh viên đã học tất cả các môn nhưng không rớt môn nào.
SELECT * FROM SINHVIEN
WHERE MSSV IN ( 
				SELECT MSSV
				FROM DIEMSV
				WHERE DIEM>=5 
				GROUP BY MSSV
				HAVING COUNT(MSSV) = (SELECT COUNT(*) FROM MONHOC)
				)

--29-	Xoá tất cả những sinh viên chưa dự thi môn nào.
DELETE 
FROM SINHVIEN
WHERE MSSV NOT IN
(
	SELECT MSSV
	FROM DIEMSV
)
--30-	Cho biết những môn đã được tất cả các sinh viên đăng ký học.
SELECT *
FROM MONHOC
WHERE MAMH IN ( 


SELECT MAMH 
FROM DIEMSV 
GROUP BY MAMH 
HAVING COUNT(MAMH) = (
						SELECT COUNT(*) FROM SINHVIEN
					 )
				)


